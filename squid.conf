# Squid secure configuration example (no SSL bump) with expanded SSL ports, blacklist integration, 
# and Docker networks added to localnet

# Access Control Lists (ACL)
# Local network ranges (including Docker subnets)
acl localnet src 192.168.0.0/16
acl localnet src 172.17.0.0/16
acl localnet src 172.18.0.0/16
acl localnet src 172.19.0.0/16

# Common ports for HTTP, HTTPS, and popular self-hosted services
acl Safe_ports port 80       # HTTP
acl Safe_ports port 443      # HTTPS
acl Safe_ports port 21       # FTP
acl Safe_ports port 8000     # Common alternative port
acl Safe_ports port 8080     # Common alternative HTTP port
acl Safe_ports port 8081     # Common alternative port
acl Safe_ports port 8443     # Common alternative HTTPS port
acl Safe_ports port 8888     # Common alternative port
acl Safe_ports port 3000     # Common dev port
acl Safe_ports port 5000     # Common dev port
acl CONNECT method CONNECT

# Blacklists
acl domain_blacklist dstdomain "/etc/squid/blacklist_fqdn.txt"
acl ip_blacklist dst "/etc/squid/blacklist_ip.txt"

# Deny requests matching blacklists
http_access deny domain_blacklist
http_access deny ip_blacklist

# Deny all non-Safe_ports
http_access deny !Safe_ports
http_access deny CONNECT !Safe_ports

# Allow local networks (including Docker subnets)
http_access allow localnet

# Deny everything else
http_access deny all

# Listen for HTTP requests
http_port 3128

# Logging
cache_log /var/log/squid/cache.log
cache_access_log /var/log/squid/access.log

# Memory and disk settings
cache_mem 256 MB
cache_dir aufs /var/spool/squid 2000 16 256

# Extra security directives
server_http11 on
forwarded_for off
request_header_access X-Forwarded-For deny all
request_header_access Via deny all
request_header_access Cache-Control deny all
request_header_access From deny all
request_header_access Referer deny all

# Final configuration
visible_hostname proxy.example.com
shutdown_lifetime 5 seconds
