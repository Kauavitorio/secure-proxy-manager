{% extends "base.html" %}
{% block title %}Settings{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Settings</h1>
    
    <div class="row">
        <div class="col-md-12">
            <form id="settings-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">General</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="filtering-tab" data-bs-toggle="tab" data-bs-target="#filtering" type="button" role="tab" aria-controls="filtering" aria-selected="false">Filtering</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="authentication-tab" data-bs-toggle="tab" data-bs-target="#authentication" type="button" role="tab" aria-controls="authentication" aria-selected="false">Authentication</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab" aria-controls="advanced" aria-selected="false">Advanced</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="database-tab" data-bs-toggle="tab" data-bs-target="#database" type="button" role="tab" aria-controls="database" aria-selected="false">Database</button>
                    </li>
                </ul>
                
                <div class="tab-content p-3 border border-top-0 rounded-bottom" id="settingsTabContent">
                    <!-- General Settings Tab -->
                    <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                        <h5 class="mb-3">Proxy Configuration</h5>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cache_size" class="form-label">Cache Size (MB)</label>
                                    <input type="number" class="form-control" id="cache_size" min="100" max="10000">
                                    <div class="form-text">Amount of disk space used for caching (in MB)</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="log_level" class="form-label">Log Level</label>
                                    <select class="form-select" id="log_level">
                                        <option value="debug">Debug</option>
                                        <option value="info">Info</option>
                                        <option value="warning">Warning</option>
                                        <option value="error">Error</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="max_object_size" class="form-label">Max Object Size (MB)</label>
                                    <input type="number" class="form-control" id="max_object_size" min="1" max="1000">
                                    <div class="form-text">Maximum size of objects to cache</div>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_compression">
                                    <label class="form-check-label" for="enable_compression">Enable Compression</label>
                                    <div class="form-text">Compress HTTP responses to save bandwidth</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtering Settings Tab -->
                    <div class="tab-pane fade" id="filtering" role="tabpanel" aria-labelledby="filtering-tab">
                        <h5 class="mb-3">Access Control & Filtering</h5>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6 class="border-bottom pb-2 mb-3">Blacklist Settings</h6>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_ip_blacklist">
                                    <label class="form-check-label" for="enable_ip_blacklist">Enable IP Blacklist</label>
                                    <div class="form-text">Block requests from blacklisted IP addresses</div>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_domain_blacklist">
                                    <label class="form-check-label" for="enable_domain_blacklist">Enable Domain Blacklist</label>
                                    <div class="form-text">Block requests to blacklisted domains</div>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="block_direct_ip">
                                    <label class="form-check-label" for="block_direct_ip">Block Direct IP Access</label>
                                    <div class="form-text">Block requests to direct IP addresses</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6 class="border-bottom pb-2 mb-3">Advanced Filtering</h6>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_content_filtering">
                                    <label class="form-check-label" for="enable_content_filtering">Enable Content Filtering</label>
                                    <div class="form-text">Filter requests based on content type</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="blocked_file_types" class="form-label">Blocked File Extensions</label>
                                    <input type="text" class="form-control" id="blocked_file_types" placeholder="exe,bat,dll,jar">
                                    <div class="form-text">Comma-separated list of file extensions to block</div>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_https_filtering">
                                    <label class="form-check-label" for="enable_https_filtering">HTTPS Filtering</label>
                                    <div class="form-text">Decrypt and inspect HTTPS traffic (requires certificate setup)</div>
                                </div>
                                
                                <div class="mb-3" id="download-cert-container">
                                    <button type="button" class="btn btn-outline-secondary" id="download-cert-btn">
                                        <i class="fas fa-download me-1"></i> Download CA Certificate
                                    </button>
                                    <div class="form-text">Install this certificate on your clients to trust HTTPS filtering</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <h6 class="border-bottom pb-2 mb-3">Time Restrictions</h6>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_time_restrictions">
                                    <label class="form-check-label" for="enable_time_restrictions">Enable Time Restrictions</label>
                                    <div class="form-text">Enable access restrictions based on time of day</div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="time_restriction_start" class="form-label">Allowed Start Time</label>
                                            <input type="time" class="form-control" id="time_restriction_start">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="time_restriction_end" class="form-label">Allowed End Time</label>
                                            <input type="time" class="form-control" id="time_restriction_end">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Authentication Tab -->
                    <div class="tab-pane fade" id="authentication" role="tabpanel" aria-labelledby="authentication-tab">
                        <h5 class="mb-3">Authentication Settings</h5>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6 class="border-bottom pb-2 mb-3">Admin Authentication</h6>
                                
                                <div class="mb-3">
                                    <label for="admin_username" class="form-label">Admin Username</label>
                                    <input type="text" class="form-control" id="admin_username" placeholder="admin">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="admin_password" class="form-label">Admin Password</label>
                                    <input type="password" class="form-control" id="admin_password" placeholder="********">
                                    <div class="form-text">Leave blank to keep current password</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6 class="border-bottom pb-2 mb-3">Proxy Authentication</h6>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_proxy_auth">
                                    <label class="form-check-label" for="enable_proxy_auth">Enable Proxy Authentication</label>
                                    <div class="form-text">Require authentication for proxy access</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="auth_method" class="form-label">Authentication Method</label>
                                    <select class="form-select" id="auth_method">
                                        <option value="basic">Basic Authentication</option>
                                        <option value="digest">Digest Authentication</option>
                                        <option value="ntlm">NTLM Authentication</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Tab -->
                    <div class="tab-pane fade" id="advanced" role="tabpanel" aria-labelledby="advanced-tab">
                        <h5 class="mb-3">Advanced Settings</h5>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6 class="border-bottom pb-2 mb-3">Performance</h6>
                                
                                <div class="mb-3">
                                    <label for="connection_timeout" class="form-label">Connection Timeout (seconds)</label>
                                    <input type="number" class="form-control" id="connection_timeout" min="1" max="300">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="dns_timeout" class="form-label">DNS Timeout (seconds)</label>
                                    <input type="number" class="form-control" id="dns_timeout" min="1" max="60">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="max_connections" class="form-label">Maximum Connections</label>
                                    <input type="number" class="form-control" id="max_connections" min="10" max="10000">
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6 class="border-bottom pb-2 mb-3">Logging & Monitoring</h6>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_extended_logging">
                                    <label class="form-check-label" for="enable_extended_logging">Enable Extended Logging</label>
                                    <div class="form-text">Log additional details about requests</div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="log_retention" class="form-label">Log Retention (days)</label>
                                    <input type="number" class="form-control" id="log_retention" min="1" max="365">
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_alerts">
                                    <label class="form-check-label" for="enable_alerts">Enable Email Alerts</label>
                                    <div class="form-text">Send email alerts for security events</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <h6 class="border-bottom pb-2 mb-3">System Maintenance</h6>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-secondary mb-3 me-2" id="clear-cache-btn">
                                            <i class="fas fa-broom me-1"></i> Clear Cache
                                        </button>
                                        
                                        <button type="button" class="btn btn-outline-secondary mb-3 me-2" id="backup-config-btn">
                                            <i class="fas fa-download me-1"></i> Backup Configuration
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-secondary mb-3 me-2" id="restore-config-btn">
                                            <i class="fas fa-upload me-1"></i> Restore Configuration
                                        </button>
                                        
                                        <button type="button" class="btn btn-outline-danger mb-3" id="reset-all-btn">
                                            <i class="fas fa-exclamation-triangle me-1"></i> Reset All Settings
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Database Operations Tab -->
                    <div class="tab-pane fade" id="database" role="tabpanel" aria-labelledby="database-tab">
                        <h5 class="mb-3">Database Management</h5>
                        
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h6 class="border-bottom pb-2 mb-3">Logs Management</h6>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>This section allows you to manage the proxy logs stored in the database.
                                </div>
                                
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <strong>Clear Logs</strong>
                                    </div>
                                    <div class="card-body">
                                        <p>Remove all proxy access logs from the database.</p>
                                        <div class="d-flex align-items-center">
                                            <button type="button" class="btn btn-danger me-3" id="clear-logs-btn">
                                                <i class="fas fa-trash-alt me-1"></i> Clear All Logs
                                            </button>
                                            <span class="text-muted small">This action cannot be undone.</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <strong>Log Retention</strong>
                                    </div>
                                    <div class="card-body">
                                        <p>Remove logs older than a specific time period.</p>
                                        <div class="row g-3 align-items-center mb-3">
                                            <div class="col-auto">
                                                <label for="retention-period" class="col-form-label">Remove logs older than</label>
                                            </div>
                                            <div class="col-auto">
                                                <select class="form-select" id="retention-period">
                                                    <option value="1">1 day</option>
                                                    <option value="7">7 days</option>
                                                    <option value="30" selected>30 days</option>
                                                    <option value="90">90 days</option>
                                                    <option value="180">180 days</option>
                                                    <option value="365">1 year</option>
                                                </select>
                                            </div>
                                            <div class="col-auto">
                                                <button type="button" class="btn btn-warning" id="clear-old-logs-btn">
                                                    <i class="fas fa-broom me-1"></i> Clear Old Logs
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h6 class="border-bottom pb-2 mb-3">Database Statistics</h6>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card text-center mb-3">
                                            <div class="card-body">
                                                <h6 class="card-title">Total Logs</h6>
                                                <h3 id="db-total-logs">Loading...</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center mb-3">
                                            <div class="card-body">
                                                <h6 class="card-title">Database Size</h6>
                                                <h3 id="db-size">Loading...</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card text-center mb-3">
                                            <div class="card-body">
                                                <h6 class="card-title">Last Log Entry</h6>
                                                <h3 id="db-last-entry">Loading...</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-outline-primary mt-2" id="refresh-db-stats-btn">
                                    <i class="fas fa-sync-alt me-1"></i> Refresh Statistics
                                </button>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h6 class="border-bottom pb-2 mb-3">Database Maintenance</h6>
                                
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <strong>Database Optimization</strong>
                                    </div>
                                    <div class="card-body">
                                        <p>Optimize the database to improve performance and reduce size.</p>
                                        <button type="button" class="btn btn-primary" id="optimize-db-btn">
                                            <i class="fas fa-database me-1"></i> Optimize Database
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <strong>Export Database</strong>
                                    </div>
                                    <div class="card-body">
                                        <p>Export the database for backup or analysis purposes.</p>
                                        <button type="button" class="btn btn-outline-secondary" id="export-db-btn">
                                            <i class="fas fa-file-export me-1"></i> Export Database
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                    <button type="button" class="btn btn-secondary me-md-2" id="reset-settings">Reset to Defaults</button>
                    <button type="button" class="btn btn-primary" id="save-settings">Save Settings</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    $(document).ready(function() {
        // Load current settings
        loadSettings();
        
        // Save settings
        $('#save-settings').click(function() {
            saveSettings();
        });
        
        // Reset settings
        $('#reset-settings').click(function() {
            if (confirm('Are you sure you want to reset all settings to default values?')) {
                resetSettings();
            }
        });
        
        // Reset all settings
        $('#reset-all-btn').click(function() {
            if (confirm('WARNING: This will reset ALL settings to factory defaults. This action cannot be undone. Continue?')) {
                resetAllSettings();
            }
        });
        
        // Clear cache
        $('#clear-cache-btn').click(function() {
            if (confirm('Are you sure you want to clear the proxy cache?')) {
                clearCache();
            }
        });
        
        // Backup configuration
        $('#backup-config-btn').click(function() {
            backupConfiguration();
        });
        
        // Restore configuration
        $('#restore-config-btn').click(function() {
            // Create a hidden file input if it doesn't exist
            if ($('#file-upload').length === 0) {
                $('body').append('<input type="file" id="file-upload" style="display:none" accept=".json">');
            }
            
            // Set up the file input event handler
            $('#file-upload').off('change').on('change', function(e) {
                if (e.target.files.length === 0) return;
                
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const config = JSON.parse(e.target.result);
                        
                        // Confirm restore
                        if (confirm('Are you sure you want to restore this configuration? Current settings will be overwritten.')) {
                            // Include CSRF token in the form data
                            const formData = new FormData();
                            formData.append('config', JSON.stringify(config));
                            formData.append('csrf_token', $('meta[name="csrf-token"]').attr('content'));
                            
                            $.ajax({
                                url: '/api/maintenance/restore-config',
                                type: 'POST',
                                data: formData,
                                processData: false,
                                contentType: false,
                                beforeSend: function(xhr) {
                                    // Add CSRF token in header as well
                                    const csrfToken = $('meta[name="csrf-token"]').attr('content');
                                    if (csrfToken) {
                                        xhr.setRequestHeader("X-CSRF-Token", csrfToken);
                                    }
                                    showLoading();
                                },
                                success: function(response) {
                                    hideLoading();
                                    showToast('Configuration restored successfully');
                                    loadSettings(); // Reload settings to show the restored values
                                },
                                error: function(xhr, status, error) {
                                    hideLoading();
                                    showToast('Failed to restore configuration: ' + error, 'danger');
                                }
                            });
                        }
                    } catch (error) {
                        showToast('Invalid configuration file: ' + error.message, 'danger');
                    }
                };
                
                reader.readAsText(file);
            });
            
            $('#file-upload').click();
        });
        
        // Hide/show file type blocking based on content filtering state
        $('#enable_content_filtering').change(function() {
            if ($(this).is(':checked')) {
                $('#blocked_file_types').closest('.mb-3').show();
            } else {
                $('#blocked_file_types').closest('.mb-3').hide();
            }
        });
        
        // Hide/show time restriction inputs based on checkbox
        $('#enable_time_restrictions').change(function() {
            if ($(this).is(':checked')) {
                $('#time_restriction_start, #time_restriction_end').closest('.mb-3').parent().parent().show();
            } else {
                $('#time_restriction_start, #time_restriction_end').closest('.mb-3').parent().parent().hide();
            }
        });
        
        // Initialize hidden elements based on checkbox states
        $('#enable_content_filtering').trigger('change');
        $('#enable_time_restrictions').trigger('change');
        
        // Toggle download cert button based on HTTPS filtering state
        $('#download-cert-container').toggle($('#enable_https_filtering').is(':checked'));
        $('#download-cert-btn').click(function() {
            window.location = '/api/maintenance/download-cert';
        });
        
        // Add HTTPS filtering validation when enabling the feature
        $('#enable_https_filtering').change(function() {
            const httpsEnabled = $(this).is(':checked');
            $('#download-cert-container').toggle(httpsEnabled);
            
            if (httpsEnabled) {
                // Check certificate health when enabling
                apiRequest('GET', 'maintenance/check-cert-security')
                    .then(function(response) {
                        if (response.status === 'warning') {
                            // Show warning about certificate issues
                            const warningModal = `
                                <div class="modal fade" id="https-warning-modal" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header bg-warning text-dark">
                                                <h5 class="modal-title">HTTPS Filtering Certificate Warning</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p><strong>Warning:</strong> The following issues were detected with your SSL certificates:</p>
                                                <ul>
                                                    ${response.details.map(issue => `<li>${issue}</li>`).join('')}
                                                </ul>
                                                <p>These issues may affect the functionality of HTTPS filtering. Please address them before enabling this feature.</p>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Understand</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            // Remove any existing modal
                            $('#https-warning-modal').remove();
                            
                            // Add the modal to the DOM and show it
                            $('body').append(warningModal);
                            new bootstrap.Modal(document.getElementById('https-warning-modal')).show();
                        }
                        else if (response.status === 'error') {
                            showToast('Error checking certificate security: ' + response.message, 'danger');
                        }
                        else if (response.status === 'success') {
                            showToast('Certificate security checks passed', 'success');
                        }
                    })
                    .catch(function(error) {
                        showToast('Failed to check certificate security: ' + error.message, 'danger');
                    });
                    
                // Show privacy implications modal
                const privacyModal = `
                    <div class="modal fade" id="https-privacy-modal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header bg-info text-white">
                                    <h5 class="modal-title">HTTPS Filtering Privacy Notice</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p><strong>Important Privacy Consideration:</strong></p>
                                    <p>Enabling HTTPS filtering means this proxy will:</p>
                                    <ul>
                                        <li>Decrypt and inspect all HTTPS traffic passing through it</li>
                                        <li>Generate certificates on-the-fly for secure websites</li>
                                        <li>Potentially have access to sensitive information in HTTPS sessions</li>
                                    </ul>
                                    <p>Users must install the proxy's CA certificate on their devices to avoid security warnings.</p>
                                    <p>Please ensure you understand the privacy and legal implications before enabling this feature.</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" id="https-privacy-disable">Disable HTTPS Filtering</button>
                                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I Understand</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove any existing modal
                $('#https-privacy-modal').remove();
                
                // Add the modal to the DOM
                $('body').append(privacyModal);
                
                // Show the privacy modal
                const modal = new bootstrap.Modal(document.getElementById('https-privacy-modal'));
                modal.show();
                
                // Handle "Disable HTTPS Filtering" button
                $('#https-privacy-disable').click(function() {
                    $('#enable_https_filtering').prop('checked', false).trigger('change');
                    modal.hide();
                });
            }
        });

        // Database tab initialization
        loadDatabaseStats();
        
        // Clear all logs button
        $('#clear-logs-btn').click(function() {
            if (confirm('WARNING: This will delete ALL proxy logs from the database. This action cannot be undone. Continue?')) {
                clearAllLogs();
            }
        });
        
        // Clear old logs button
        $('#clear-old-logs-btn').click(function() {
            const days = $('#retention-period').val();
            if (confirm(`Are you sure you want to remove logs older than ${days} days? This action cannot be undone.`)) {
                clearOldLogs(days);
            }
        });
        
        // Refresh database stats button
        $('#refresh-db-stats-btn').click(function() {
            $(this).find('i').addClass('fa-spin');
            loadDatabaseStats().finally(() => {
                $(this).find('i').removeClass('fa-spin');
            });
        });
        
        // Optimize database button
        $('#optimize-db-btn').click(function() {
            $(this).prop('disabled', true);
            $(this).html('<i class="fas fa-spinner fa-spin me-1"></i> Optimizing...');
            
            optimizeDatabase().finally(() => {
                $(this).prop('disabled', false);
                $(this).html('<i class="fas fa-database me-1"></i> Optimize Database');
            });
        });
        
        // Export database button
        $('#export-db-btn').click(function() {
            $(this).prop('disabled', true);
            $(this).html('<i class="fas fa-spinner fa-spin me-1"></i> Exporting...');
            
            exportDatabase().finally(() => {
                $(this).prop('disabled', false);
                $(this).html('<i class="fas fa-file-export me-1"></i> Export Database');
            });
        });
    });
    
    function loadSettings() {
        apiRequest('GET', 'settings')
            .then(function(response) {
                if (response.status === 'success') {
                    const settings = {};
                    response.data.forEach(setting => {
                        settings[setting.setting_name] = setting.setting_value;
                    });
                    
                    // Update basic settings
                    $('#enable_ip_blacklist').prop('checked', settings.enable_ip_blacklist === 'true');
                    $('#enable_domain_blacklist').prop('checked', settings.enable_domain_blacklist === 'true');
                    $('#block_direct_ip').prop('checked', settings.block_direct_ip === 'true');
                    $('#log_level').val(settings.log_level);
                    
                    // Update advanced settings (with defaults if not present)
                    $('#cache_size').val(settings.cache_size || '1000');
                    $('#max_object_size').val(settings.max_object_size || '50');
                    $('#enable_compression').prop('checked', settings.enable_compression === 'true');
                    $('#connection_timeout').val(settings.connection_timeout || '30');
                    $('#dns_timeout').val(settings.dns_timeout || '5');
                    $('#max_connections').val(settings.max_connections || '100');
                    
                    // Update filtering settings
                    $('#enable_content_filtering').prop('checked', settings.enable_content_filtering === 'true');
                    $('#blocked_file_types').val(settings.blocked_file_types || 'exe,bat,cmd,dll,js');
                    $('#enable_https_filtering').prop('checked', settings.enable_https_filtering === 'true');
                    $('#enable_time_restrictions').prop('checked', settings.enable_time_restrictions === 'true');
                    $('#time_restriction_start').val(settings.time_restriction_start || '09:00');
                    $('#time_restriction_end').val(settings.time_restriction_end || '17:00');
                    
                    // Update auth settings
                    $('#enable_proxy_auth').prop('checked', settings.enable_proxy_auth === 'true');
                    $('#auth_method').val(settings.auth_method || 'basic');
                    
                    // Update logging settings
                    $('#enable_extended_logging').prop('checked', settings.enable_extended_logging === 'true');
                    $('#log_retention').val(settings.log_retention || '30');
                    $('#enable_alerts').prop('checked', settings.enable_alerts === 'true');
                    
                    // For demonstration, we're not actually loading the username/password from backend
                    // as that would be a security risk
                    $('#admin_username').val('admin');
                    
                    // Trigger change events to update UI
                    $('#enable_content_filtering').trigger('change');
                    $('#enable_time_restrictions').trigger('change');
                    $('#enable_https_filtering').trigger('change');
                }
            })
            .catch(function(error) {
                showToast('Failed to load settings: ' + error.message, 'danger');
            });
    }
    
    function saveSettings() {
        // Collect all settings
        const settings = {
            // Basic settings
            enable_ip_blacklist: $('#enable_ip_blacklist').is(':checked') ? 'true' : 'false',
            enable_domain_blacklist: $('#enable_domain_blacklist').is(':checked') ? 'true' : 'false',
            block_direct_ip: $('#block_direct_ip').is(':checked') ? 'true' : 'false',
            log_level: $('#log_level').val(),
            
            // Advanced settings
            cache_size: $('#cache_size').val(),
            max_object_size: $('#max_object_size').val(),
            enable_compression: $('#enable_compression').is(':checked') ? 'true' : 'false',
            connection_timeout: $('#connection_timeout').val(),
            dns_timeout: $('#dns_timeout').val(),
            max_connections: $('#max_connections').val(),
            
            // Filtering settings
            enable_content_filtering: $('#enable_content_filtering').is(':checked') ? 'true' : 'false',
            blocked_file_types: $('#blocked_file_types').val(),
            enable_https_filtering: $('#enable_https_filtering').is(':checked') ? 'true' : 'false',
            enable_time_restrictions: $('#enable_time_restrictions').is(':checked') ? 'true' : 'false',
            time_restriction_start: $('#time_restriction_start').val(),
            time_restriction_end: $('#time_restriction_end').val(),
            
            // Auth settings
            enable_proxy_auth: $('#enable_proxy_auth').is(':checked') ? 'true' : 'false',
            auth_method: $('#auth_method').val(),
            
            // Logging settings
            enable_extended_logging: $('#enable_extended_logging').is(':checked') ? 'true' : 'false',
            log_retention: $('#log_retention').val(),
            enable_alerts: $('#enable_alerts').is(':checked') ? 'true' : 'false'
        };
        
        // Save each setting
        const promises = [];
        
        for (const [name, value] of Object.entries(settings)) {
            promises.push(
                apiRequest('PUT', `settings/${name}`, { value: value })
                    .catch(function(error) {
                        showToast(`Failed to update ${name}: ${error.message}`, 'danger');
                        throw error;
                    })
            );
        }
        
        // Handle authentication changes if password was updated
        const newPassword = $('#admin_password').val();
        if (newPassword) {
            // Validate password on submission
            const validation = validatePassword(newPassword);
            if (!validation.valid) {
                showToast('Password does not meet security requirements', 'danger');
                return;
            }
            
            // Submit password change request
            apiRequest('POST', 'change-password', {
                current_password: 'admin', // In a real app, you'd prompt for current password
                new_password: newPassword
            })
            .then(function(response) {
                showToast('Password changed successfully', 'success');
                $('#admin_password').val(''); // Clear password field
            })
            .catch(function(error) {
                showToast('Failed to change password: ' + error.message, 'danger');
            });
        }
        
        // Wait for all settings to be updated
        Promise.all(promises)
            .then(function() {
                showToast('Settings saved successfully');
            })
            .catch(function(error) {
                // Individual errors are already handled above
                console.error('Some settings failed to save:', error);
            });
    }
    
    function resetSettings() {
        // Set default values for basic settings
        $('#enable_ip_blacklist').prop('checked', true);
        $('#enable_domain_blacklist').prop('checked', true);
        $('#block_direct_ip').prop('checked', true);
        $('#log_level').val('info');
        
        // Save the default settings
        saveSettings();
    }
    
    function resetAllSettings() {
        // Set factory defaults for all settings
        $('#enable_ip_blacklist').prop('checked', true);
        $('#enable_domain_blacklist').prop('checked', true);
        $('#block_direct_ip').prop('checked', true);
        $('#log_level').val('info');
        
        $('#cache_size').val('1000');
        $('#max_object_size').val('50');
        $('#enable_compression').prop('checked', false);
        $('#connection_timeout').val('30');
        $('#dns_timeout').val('5');
        $('#max_connections').val('100');
        
        $('#enable_content_filtering').prop('checked', false);
        $('#blocked_file_types').val('exe,bat,cmd,dll,js');
        $('#enable_https_filtering').prop('checked', false);
        $('#enable_time_restrictions').prop('checked', false);
        $('#time_restriction_start').val('09:00');
        $('#time_restriction_end').val('17:00');
        
        $('#enable_proxy_auth').prop('checked', false);
        $('#auth_method').val('basic');
        
        $('#enable_extended_logging').prop('checked', false);
        $('#log_retention').val('30');
        $('#enable_alerts').prop('checked', false);
        
        // Trigger change events to update UI
        $('#enable_content_filtering').trigger('change');
        $('#enable_time_restrictions').trigger('change');
        $('#enable_https_filtering').trigger('change');
        
        // Save all settings
        saveSettings();
    }
    
    function clearCache() {
        apiRequest('POST', 'maintenance/clear-cache')
            .then(function(response) {
                showToast('Cache cleared successfully');
            })
            .catch(function(error) {
                showToast('Failed to clear cache: ' + error.message, 'danger');
            });
    }
    
    function backupConfiguration() {
        apiRequest('GET', 'maintenance/backup-config')
            .then(function(response) {
                // Create a download link for the configuration
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(response.data));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "secure-proxy-config-" + new Date().toISOString().slice(0, 10) + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
                
                showToast('Configuration backup created');
            })
            .catch(function(error) {
                showToast('Failed to backup configuration: ' + error.message, 'danger');
            });
    }
    
    // Password validation function
    function validatePassword(password) {
        const validationResults = {
            valid: false,
            errors: []
        };
        
        // Check length
        if (password.length < 8) {
            validationResults.errors.push("Password must be at least 8 characters long");
        }
        
        // Check for at least one number
        if (!/\d/.test(password)) {
            validationResults.errors.push("Password must contain at least one number");
        }
        
        // Check for at least one special character
        if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
            validationResults.errors.push("Password must contain at least one special character");
        }
        
        // Set valid flag if no errors
        validationResults.valid = validationResults.errors.length === 0;
        
        return validationResults;
    }
    
    // Add validation to password field
    $(document).ready(function() {
        // Create feedback element for password validation
        $('<div id="password-feedback" class="mt-2"></div>').insertAfter('#admin_password');
        
        // Add keyup event for live validation feedback
        $('#admin_password').keyup(function() {
            const password = $(this).val();
            const feedback = $('#password-feedback');
            
            // Clear feedback if empty
            if (!password) {
                feedback.html('').removeClass('text-danger text-success');
                return;
            }
            
            // Validate password
            const validation = validatePassword(password);
            
            if (validation.valid) {
                feedback.html('<i class="fas fa-check-circle"></i> Password meets security requirements').removeClass('text-danger').addClass('text-success');
            } else {
                feedback.html('<i class="fas fa-exclamation-circle"></i> ' + validation.errors.join('<br>')).removeClass('text-success').addClass('text-danger');
            }
        });

        // Add change password functionality
        $('#save-settings').click(function() {
            const newPassword = $('#admin_password').val();
            if (newPassword) {
                // Validate password on submission
                const validation = validatePassword(newPassword);
                if (!validation.valid) {
                    showToast('Password does not meet security requirements', 'danger');
                    return;
                }
                
                // Submit password change request
                apiRequest('POST', 'change-password', {
                    current_password: 'admin', // In a real app, you'd prompt for current password
                    new_password: newPassword
                })
                .then(function(response) {
                    showToast('Password changed successfully', 'success');
                    $('#admin_password').val(''); // Clear password field
                })
                .catch(function(error) {
                    showToast('Failed to change password: ' + error.message, 'danger');
                });
            }
        });
    });

    // Database tab functions
    function loadDatabaseStats() {
        return apiRequest('GET', 'logs/stats')
            .then(function(response) {
                if (response.status === 'success') {
                    // Update statistics
                    const totalLogs = response.data.total_count || 0;
                    $('#db-total-logs').text(totalLogs.toLocaleString());
                    
                    // Format the last log entry as a date if available
                    if (response.data.last_import) {
                        try {
                            const lastEntry = new Date(response.data.last_import);
                            $('#db-last-entry').text(lastEntry.toLocaleString());
                        } catch (e) {
                            $('#db-last-entry').text(response.data.last_import || 'None');
                        }
                    } else {
                        $('#db-last-entry').text('None');
                    }
                    
                    // Get database size estimation (this is an approximation)
                    apiRequest('GET', 'database/size')
                        .then(function(sizeResponse) {
                            if (sizeResponse.status === 'success') {
                                $('#db-size').text(sizeResponse.data.size || 'Unknown');
                            } else {
                                // Fallback size estimation based on logs
                                const estimatedSize = Math.round(totalLogs * 0.5); // rough estimate: 0.5KB per log entry
                                if (estimatedSize < 1024) {
                                    $('#db-size').text(estimatedSize + ' KB');
                                } else {
                                    $('#db-size').text(Math.round(estimatedSize / 1024 * 10) / 10 + ' MB');
                                }
                            }
                        })
                        .catch(function() {
                            // Fallback on error
                            $('#db-size').text('Unknown');
                        });
                } else {
                    $('#db-total-logs').text('Error');
                    $('#db-size').text('Error');
                    $('#db-last-entry').text('Error');
                }
            })
            .catch(function(error) {
                console.error('Failed to load database statistics:', error);
                $('#db-total-logs').text('Error');
                $('#db-size').text('Error');
                $('#db-last-entry').text('Error');
                return Promise.reject(error);
            });
    }
    
    function clearAllLogs() {
        return apiRequest('POST', 'logs/clear', {
            csrf_token: $('meta[name="csrf-token"]').attr('content')
        })
            .then(function(response) {
                if (response.status === 'success') {
                    showToast('All logs cleared successfully');
                    // Refresh the statistics
                    loadDatabaseStats();
                    return true;
                } else {
                    showToast('Failed to clear logs: ' + response.message, 'danger');
                    return false;
                }
            })
            .catch(function(error) {
                showToast('Failed to clear logs: ' + error.message, 'danger');
                return Promise.reject(error);
            });
    }
    
    function clearOldLogs(days) {
        return apiRequest('POST', 'logs/clear-old', { 
            days: days,
            csrf_token: $('meta[name="csrf-token"]').attr('content')
        })
            .then(function(response) {
                if (response.status === 'success') {
                    showToast(`Logs older than ${days} days cleared successfully`);
                    // Refresh the statistics
                    loadDatabaseStats();
                    return true;
                } else {
                    showToast('Failed to clear old logs: ' + response.message, 'danger');
                    return false;
                }
            })
            .catch(function(error) {
                showToast('Failed to clear old logs: ' + error.message, 'danger');
                return Promise.reject(error);
            });
    }
    
    function optimizeDatabase() {
        return apiRequest('POST', 'database/optimize', {})
            .then(function(response) {
                if (response.status === 'success') {
                    showToast('Database optimized successfully');
                    // Refresh the statistics
                    loadDatabaseStats();
                    return true;
                } else {
                    showToast('Failed to optimize database: ' + response.message, 'danger');
                    return false;
                }
            })
            .catch(function(error) {
                showToast('Failed to optimize database: ' + error.message, 'danger');
                return Promise.reject(error);
            });
    }
    
    function exportDatabase() {
        return apiRequest('GET', 'database/export')
            .then(function(response) {
                if (response.status === 'success') {
                    // Create a download link for the database export
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(response.data));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "secure-proxy-db-export-" + new Date().toISOString().slice(0, 10) + ".json");
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                    
                    showToast('Database exported successfully');
                    return true;
                } else {
                    showToast('Failed to export database: ' + response.message, 'danger');
                    return false;
                }
            })
            .catch(function(error) {
                showToast('Failed to export database: ' + error.message, 'danger');
                return Promise.reject(error);
            });
    }
</script>
{% endblock %}