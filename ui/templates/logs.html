{% extends "base.html" %}
{% block title %}Logs{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Proxy Logs</h1>
    
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Access Logs</h5>
            <div class="d-flex align-items-center">
                <div class="form-check form-switch me-3">
                    <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                    <label class="form-check-label" for="auto-refresh">Auto Refresh</label>
                </div>
                <div class="me-3">
                    <select class="form-select form-select-sm" id="refresh-interval">
                        <option value="5000">5 sec</option>
                        <option value="10000" selected>10 sec</option>
                        <option value="30000">30 sec</option>
                        <option value="60000">1 min</option>
                    </select>
                </div>
                <button id="refresh-logs" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <div class="form-check form-switch me-3">
                    <input class="form-check-input" type="checkbox" id="auto-import" checked>
                    <label class="form-check-label" for="auto-import">Auto Import</label>
                </div>
                <button id="import-logs" class="btn btn-primary me-2">
                    <i class="fas fa-download me-1"></i>Import Logs
                </button>
                <button id="clear-logs" class="btn btn-danger">
                    <i class="fas fa-trash-alt me-1"></i>Clear Logs
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <div class="row g-3 align-items-center">
                    <div class="col-auto">
                        <label for="logs-per-page" class="col-form-label">Show</label>
                    </div>
                    <div class="col-auto">
                        <select class="form-select" id="logs-per-page">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <span class="form-text">entries</span>
                    </div>
                    <div class="col-md-4 ms-auto">
                        <div class="input-group">
                            <input type="text" class="form-control" id="log-search" placeholder="Search logs...">
                            <button class="btn btn-outline-secondary" type="button" id="search-logs">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover" id="logs-table">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="timestamp">Timestamp <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="source_ip">Source IP <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="destination">Destination <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="status">Status <i class="fas fa-sort"></i></th>
                            <th class="sortable" data-sort="bytes">Bytes <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody id="logs-data">
                        <tr>
                            <td colspan="5" class="text-center">Loading logs...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div id="logs-showing-info">Showing 0 to 0 of 0 entries</div>
                <nav aria-label="Logs pagination">
                    <ul class="pagination" id="logs-pagination">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Logs Status</h5>
            <div>
                <span class="badge bg-success" id="logs-status">Connected</span>
                <span class="text-muted ms-2" id="last-update-time"></span>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6 class="card-title">Total Log Entries</h6>
                            <h3 class="mb-0" id="total-log-count">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6 class="card-title">Blocked Requests</h6>
                            <h3 class="mb-0" id="blocked-count">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6 class="card-title">Direct IP Blocks</h6>
                            <h3 class="mb-0" id="ip-blocks-count">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6 class="card-title">Last Import</h6>
                            <h3 class="mb-0" id="last-import-time">Never</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // HTML escaping function to prevent XSS
    function escapeHtml(text) {
        if (text === null || text === undefined) {
            return 'Unknown';
        }
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    $(document).ready(function() {
        // Initial data
        let currentPage = 0;
        let logsPerPage = 25;
        let totalLogs = 0;
        let searchTerm = '';
        let autoRefreshInterval = null;
        let autoImportInterval = null;
        let lastUpdateTime = new Date();
        let refreshInterval = parseInt($('#refresh-interval').val());
        let isAutoRefreshEnabled = $('#auto-refresh').is(':checked');
        let isAutoImportEnabled = $('#auto-import').is(':checked');
        let blockedCount = 0;
        let ipBlocksCount = 0;
        let lastImportTime = null;
        let currentSortColumn = 'timestamp'; // Default sort by timestamp
        let currentSortOrder = 'desc'; // Default sort order is descending (latest first)
        
        // Start auto refresh if enabled
        updateAutoRefresh();
        
        // Start auto import if enabled
        updateAutoImport();
        
        // Initial log fetch
        loadLogs();
        
        // Get log statistics
        getLogStats();
        
        // Toggle auto refresh
        $('#auto-refresh').change(function() {
            isAutoRefreshEnabled = $(this).is(':checked');
            updateAutoRefresh();
            
            // Show toast notification
            const status = isAutoRefreshEnabled ? 'enabled' : 'disabled';
            showToast(`Auto refresh ${status}`, 'info');
        });
        
        // Change refresh interval
        $('#refresh-interval').change(function() {
            refreshInterval = parseInt($(this).val());
            if (isAutoRefreshEnabled) {
                updateAutoRefresh();
            }
            showToast(`Refresh interval set to ${refreshInterval / 1000} seconds`, 'info');
        });
        
        // Toggle auto import
        $('#auto-import').change(function() {
            isAutoImportEnabled = $(this).is(':checked');
            updateAutoImport();
            
            // Show toast notification
            const status = isAutoImportEnabled ? 'enabled' : 'disabled';
            showToast(`Auto import ${status}`, 'info');
        });
        
        // Refresh logs button
        $('#refresh-logs').click(function() {
            $(this).find('i').addClass('fa-spin');
            loadLogs().finally(() => {
                $(this).find('i').removeClass('fa-spin');
            });
        });
        
        // Import logs button
        $('#import-logs').click(function() {
            $(this).prop('disabled', true);
            $(this).html('<i class="fas fa-spinner fa-spin me-1"></i>Importing...');
            
            importLogs().finally(() => {
                $(this).prop('disabled', false);
                $(this).html('<i class="fas fa-download me-1"></i>Import Logs');
            });
        });
        
        // Clear logs button
        $('#clear-logs').click(function() {
            $(this).prop('disabled', true);
            $(this).html('<i class="fas fa-spinner fa-spin me-1"></i>Clearing...');
            
            clearLogs().finally(() => {
                $(this).prop('disabled', false);
                $(this).html('<i class="fas fa-trash-alt me-1"></i>Clear Logs');
            });
        });
        
        // Change logs per page
        $('#logs-per-page').change(function() {
            logsPerPage = parseInt($(this).val());
            currentPage = 0; // Reset to first page
            loadLogs();
        });
        
        // Search logs
        $('#search-logs').click(function() {
            searchTerm = $('#log-search').val().trim();
            currentPage = 0; // Reset to first page
            loadLogs();
        });
        
        // Handle enter key in search box
        $('#log-search').keypress(function(e) {
            if (e.which === 13) {
                $('#search-logs').click();
            }
        });
        
        // Add click handlers for sortable columns
        $('.sortable').click(function() {
            const column = $(this).data('sort');
            
            // If clicking the same column, toggle sort order
            if (column === currentSortColumn) {
                currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                // New column, default to descending order (latest first)
                currentSortColumn = column;
                currentSortOrder = 'desc';
            }
            
            // Update sort icons
            updateSortIcons();
            
            // Reload logs with new sort
            loadLogs();
        });
        
        // Function to update sort icons
        function updateSortIcons() {
            // Reset all icons
            $('.sortable i').attr('class', 'fas fa-sort');
            
            // Set the active column's icon
            const activeColumn = $(`.sortable[data-sort="${currentSortColumn}"]`);
            if (currentSortOrder === 'asc') {
                activeColumn.find('i').attr('class', 'fas fa-sort-up');
            } else {
                activeColumn.find('i').attr('class', 'fas fa-sort-down');
            }
        }
        
        // Function to update auto refresh
        function updateAutoRefresh() {
            // Clear any existing interval
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            
            // Set new interval if enabled
            if (isAutoRefreshEnabled) {
                autoRefreshInterval = setInterval(function() {
                    loadLogs();
                    $('#logs-status').removeClass('bg-danger').addClass('bg-success').text('Connected');
                }, refreshInterval);
                
                $('#logs-status').removeClass('bg-danger').addClass('bg-success').text('Connected');
            } else {
                $('#logs-status').removeClass('bg-success').addClass('bg-danger').text('Paused');
            }
        }
        
        // Function to update auto import
        function updateAutoImport() {
            // Clear any existing interval
            if (autoImportInterval) {
                clearInterval(autoImportInterval);
                autoImportInterval = null;
            }
            
            // Set new interval if enabled (every 2 minutes)
            if (isAutoImportEnabled) {
                autoImportInterval = setInterval(function() {
                    importLogs();
                }, 120000);  // 2 minutes
            }
        }
        
        // Function to load logs
        function loadLogs() {
            const offset = currentPage * logsPerPage;
            let params = `limit=${logsPerPage}&offset=${offset}`;
            
            if (searchTerm) {
                params += `&search=${encodeURIComponent(searchTerm)}`;
            }
            
            // Add sort parameters
            params += `&sort=${encodeURIComponent(currentSortColumn)}&order=${encodeURIComponent(currentSortOrder)}`;
            
            return apiRequest('GET', `logs?${params}`)
                .then(function(response) {
                    if (response.status === 'success') {
                        const logs = response.data;
                        totalLogs = response.meta.total;
                        
                        // Update table
                        updateLogsTable(logs);
                        
                        // Update pagination
                        updatePagination();
                        
                        // Update info
                        const start = totalLogs === 0 ? 0 : offset + 1;
                        const end = Math.min(offset + logsPerPage, totalLogs);
                        $('#logs-showing-info').text(`Showing ${start} to ${end} of ${totalLogs} entries`);
                        
                        // Update total log count
                        $('#total-log-count').text(totalLogs.toLocaleString());
                        
                        // Update last update time
                        lastUpdateTime = new Date();
                        $('#last-update-time').text(`Last updated: ${lastUpdateTime.toLocaleTimeString()}`);
                        
                        // Get log statistics
                        getLogStats();
                        
                        // Update sort icons
                        updateSortIcons();
                    }
                })
                .catch(function(error) {
                    $('#logs-data').html('<tr><td colspan="5" class="text-center text-danger">Failed to load logs</td></tr>');
                    showToast('Failed to load logs: ' + error.message, 'danger');
                    $('#logs-status').removeClass('bg-success').addClass('bg-danger').text('Error');
                });
        }
        
        // Function to update the logs table
        function updateLogsTable(logs) {
            if (logs.length === 0) {
                $('#logs-data').html('<tr><td colspan="5" class="text-center">No logs found</td></tr>');
                return;
            }
            
            let html = '';
            logs.forEach(log => {
                // Safely check properties with fallbacks
                const timestamp = log.timestamp || 'Unknown';
                const source_ip = log.source_ip || 'Unknown';
                const destination = log.destination || 'Unknown';
                const status = log.status || 'Unknown';
                const bytes = log.bytes !== undefined ? log.bytes : 'Unknown';
                
                // Determine row class based on status code
                let rowClass = '';
                if (typeof status === 'number') {
                    if (status >= 400 && status < 500) {
                        rowClass = 'table-warning';  // Client errors
                    } else if (status >= 500) {
                        rowClass = 'table-danger';   // Server errors
                    }
                } else if (status === 0 || status === 'TCP_DENIED' || 
                          (typeof status === 'string' && 
                           (status.includes('DENIED') || status.includes('BLOCKED')))) {
                    rowClass = 'table-danger';   // Blocked requests
                }
                
                // Safe date formatting with fallback
                let formattedDate;
                try {
                    formattedDate = new Date(timestamp).toLocaleString();
                    // Check if date is valid
                    if (formattedDate === "Invalid Date") {
                        formattedDate = timestamp;
                    }
                } catch (e) {
                    formattedDate = timestamp;
                }
                
                html += `
                    <tr class="${rowClass}">
                        <td>${escapeHtml(formattedDate)}</td>
                        <td>${escapeHtml(source_ip)}</td>
                        <td>${escapeHtml(destination)}</td>
                        <td>${escapeHtml(status)}</td>
                        <td>${escapeHtml(bytes)}</td>
                    </tr>
                `;
            });
            
            $('#logs-data').html(html);
        }
        
        // Function to update pagination
        function updatePagination() {
            const totalPages = Math.ceil(totalLogs / logsPerPage);
            let paginationHtml = '';
            
            // Previous button
            paginationHtml += `
                <li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
                </li>
            `;
            
            // Page numbers
            const maxPagesToShow = 5;
            let startPage = Math.max(0, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages - 1, startPage + maxPagesToShow - 1);
            
            // Adjust startPage if we're near the end
            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(0, endPage - maxPagesToShow + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i + 1}</a>
                    </li>
                `;
            }
            
            // Next button
            paginationHtml += `
                <li class="page-item ${currentPage >= totalPages - 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
                </li>
            `;
            
            $('#logs-pagination').html(paginationHtml);
            
            // Add click handlers to pagination links
            $('.page-link').click(function(e) {
                e.preventDefault();
                
                if ($(this).parent().hasClass('disabled')) {
                    return;
                }
                
                currentPage = parseInt($(this).data('page'));
                loadLogs();
            });
        }
        
        // Function to import logs
        function importLogs() {
            return apiRequest('POST', 'logs/import')
                .then(function(response) {
                    if (response.status === 'success') {
                        showToast('Logs imported successfully');
                        lastImportTime = new Date();
                        $('#last-import-time').text(lastImportTime.toLocaleTimeString());
                        loadLogs(); // Refresh logs
                    }
                })
                .catch(function(error) {
                    showToast('Failed to import logs: ' + error.message, 'danger');
                });
        }
        
        // Function to clear logs
        function clearLogs() {
            return apiRequest('POST', 'logs/clear')
                .then(function(response) {
                    if (response.status === 'success') {
                        showToast('Logs cleared successfully');
                        loadLogs(); // Refresh logs
                    }
                })
                .catch(function(error) {
                    showToast('Failed to clear logs: ' + error.message, 'danger');
                });
        }
        
        // Function to get log statistics
        function getLogStats() {
            apiRequest('GET', 'logs/stats')
                .then(function(response) {
                    if (response.status === 'success') {
                        // Update statistics
                        blockedCount = response.data.blocked_count || 0;
                        ipBlocksCount = response.data.ip_blocks_count || 0;
                        
                        $('#blocked-count').text(blockedCount.toLocaleString());
                        $('#ip-blocks-count').text(ipBlocksCount.toLocaleString());
                        
                        if (response.data.last_import) {
                            lastImportTime = new Date(response.data.last_import);
                            $('#last-import-time').text(lastImportTime.toLocaleTimeString());
                        }
                    }
                })
                .catch(function(error) {
                    console.error('Failed to load log statistics:', error);
                });
        }
        
        // Clean up intervals when leaving the page
        $(window).on('beforeunload', function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            if (autoImportInterval) {
                clearInterval(autoImportInterval);
            }
        });
        
        // Initialize sort icons
        updateSortIcons();
    });
</script>
{% endblock %}

<style>
/* Add styles for sortable columns */
.sortable {
    cursor: pointer;
    position: relative;
}

.sortable:hover {
    background-color: rgba(0,0,0,0.05);
}

.sortable i {
    margin-left: 5px;
}
</style>