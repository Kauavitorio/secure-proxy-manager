{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block extra_styles %}
<style>
    /* Stats Card Styling */
    .stats-card {
        border-radius: 10px;
        transition: all 0.2s ease;
        height: 100%;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
    }
    
    .stats-card .card-body {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 1.25rem;
    }
    
    .stats-card h3 {
        font-size: 2rem;
        font-weight: 600;
        margin-top: 0.5rem;
    }
    
    .stats-card .card-title {
        font-size: 0.9rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
    }
    
    .stats-icon {
        font-size: 1.5rem;
        height: 2.5rem;
        width: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin-bottom: 0.75rem;
    }
    
    .icon-primary {
        background-color: rgba(67, 97, 238, 0.1);
        color: var(--primary-color);
    }
    
    .icon-success {
        background-color: rgba(76, 201, 240, 0.1);
        color: var(--success-color);
    }
    
    .icon-danger {
        background-color: rgba(249, 65, 68, 0.1);
        color: var(--danger-color);
    }
    
    .icon-warning {
        background-color: rgba(248, 150, 30, 0.1);
        color: var(--warning-color);
    }
    
    /* Responsive adjustments */
    @media (max-width: 992px) {
        .stats-card h3 {
            font-size: 1.5rem;
        }
    }
    
    @media (max-width: 768px) {
        .row-cols-md-4 > * {
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Dashboard</h1>
    
    <!-- Stats Cards Row -->
    <div class="row row-cols-1 row-cols-md-4 g-4 mb-4">
        <div class="col">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="stats-icon icon-primary">
                        <i class="fas fa-server"></i>
                    </div>
                    <h6 class="card-title">Proxy Info</h6>
                    <h3 id="proxy-status-card">...</h3>
                    <div class="d-flex align-items-center justify-content-center">
                        <div id="proxy-status-indicator-card" class="status-indicator status-inactive me-2"></div>
                        <small class="text-muted" id="status-time-short">--</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="stats-icon icon-success">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <h6 class="card-title">Requests Today</h6>
                    <h3 id="proxy-requests-card">0</h3>
                    <small class="text-muted" id="proxy-requests-subtitle">Loading...</small>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="stats-icon icon-danger">
                        <i class="fas fa-ban"></i>
                    </div>
                    <h6 class="card-title">Blocked Requests</h6>
                    <h3 id="blocked-requests-card">0</h3>
                    <small class="text-muted">Security Events</small>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card stats-card">
                <div class="card-body">
                    <div class="stats-icon icon-warning">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h6 class="card-title">Security Score</h6>
                    <h3 id="security-score-card">--</h3>
                    <small class="text-muted" id="security-status-card">Analyzing...</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions Card (Full Width Row)-->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap gap-2 justify-content-between">
                        <button class="btn btn-primary">
                            <i class="fas fa-sync-alt me-2"></i>Reload Configuration
                        </button>
                        <button class="btn btn-info text-white">
                            <i class="fas fa-download me-2"></i>Import Logs
                        </button>
                        <button class="btn btn-secondary">
                            <i class="fas fa-file-export me-2"></i>Export Settings
                        </button>
                        <button class="btn btn-danger">
                            <i class="fas fa-trash-alt me-2"></i>Clear Logs
                        </button>
                        <button class="btn btn-success" id="optimize-cache-btn">
                            <i class="fas fa-tachometer-alt me-2"></i>Optimize Cache
                        </button>
                        <button class="btn btn-warning text-white" id="scan-security-btn">
                            <i class="fas fa-shield-alt me-2"></i>Security Scan
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Proxy Status Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Proxy Status</h5>
                    <button id="refresh-status" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div id="proxy-status-indicator" class="status-indicator status-inactive"></div>
                        <h3 id="proxy-status" class="mb-0">Loading...</h3>
                    </div>
                    <div class="small text-muted" id="status-time">Last updated: --</div>
                    <div class="mt-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Version:</span>
                            <span id="proxy-version">--</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Proxied Requests:</span>
                            <span id="proxy-requests">--</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Blocked Requests:</span>
                            <span id="blocked-requests">--</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span>Memory Usage:</span>
                            <span id="memory-usage">--</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span>CPU Usage:</span>
                            <span id="cpu-usage">--</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span>Uptime:</span>
                            <span id="uptime">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- System Information Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">System Information</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-3">
                        <span>Blacklisted IPs:</span>
                        <span id="blacklisted-ips">--</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Blacklisted Domains:</span>
                        <span id="blacklisted-domains">--</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>IP Block Enabled:</span>
                        <span id="ip-block-status">--</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Domain Block Enabled:</span>
                        <span id="domain-block-status">--</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Direct IP Access Block:</span>
                        <span id="direct-ip-block-status">--</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Content Filtering:</span>
                        <span id="content-filtering-status">--</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Client Stats Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Client Statistics</h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary client-data-toggle active" data-view="clients">Clients</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary client-data-toggle" data-view="domains">Domains</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Client List View -->
                    <div id="client-list-view">
                        <div class="d-flex justify-content-between mb-3 align-items-center">
                            <h6 class="mb-0">Top Active Clients</h6>
                            <span class="badge bg-primary" id="total-clients-count">0</span>
                        </div>
                        <div class="table-responsive" style="max-height: 280px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>IP Address</th>
                                        <th>Requests</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="client-list-table">
                                    <tr>
                                        <td colspan="3" class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span class="ms-2">Loading client data...</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Popular Domains View (Hidden by default) -->
                    <div id="domain-list-view" style="display: none;">
                        <div class="d-flex justify-content-between mb-3 align-items-center">
                            <h6 class="mb-0">Most Requested Domains</h6>
                            <span class="badge bg-primary" id="total-domains-count">0</span>
                        </div>
                        <div class="table-responsive" style="max-height: 280px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Domain</th>
                                        <th>Requests</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="domain-list-table">
                                    <tr>
                                        <td colspan="3" class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span class="ms-2">Loading domain data...</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Row: Additional Cards -->
    <div class="row">
        <!-- Security Score Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Security Score</h5>
                    <button id="refresh-security" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="security-score-circle position-relative mx-auto" style="width:150px;height:150px;">
                            <div class="position-absolute top-50 start-50 translate-middle">
                                <h1 id="security-score">--</h1>
                                <div class="small">POINTS</div>
                            </div>
                        </div>
                        <h5 id="security-status" class="mt-3">Analyzing...</h5>
                    </div>
                    <div id="security-recommendations" class="mt-4">
                        <p class="fw-bold">Recommendations:</p>
                        <ul class="small" id="recommendations-list">
                            <li>Loading recommendations...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Traffic Statistics Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Traffic Statistics</h5>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary traffic-period active" data-period="day">Day</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary traffic-period" data-period="week">Week</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary traffic-period" data-period="month">Month</button>
                    </div>
                </div>
                <div class="card-body">
                    <div style="height: 200px;">
                        <canvas id="traffic-chart"></canvas>
                    </div>
                    <div class="row mt-4">
                        <div class="col-6">
                            <div class="text-center">
                                <h5 id="total-allowed">--</h5>
                                <div class="small text-muted">Allowed Requests</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <h5 id="total-blocked">--</h5>
                                <div class="small text-muted">Blocked Requests</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-3 border-top pt-3">
                        <h6>Active Connections: <span id="active-connections">--</span></h6>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cache Statistics Card -->
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Cache Performance</h5>
                    <button id="refresh-cache" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Cache Usage</label>
                        <div class="progress mb-2" style="height: 15px;">
                            <div id="cache-usage-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="small text-end"><span id="cache-used">0</span> / <span id="cache-total">0</span> MB</div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="text-center border rounded p-3">
                                <h3 id="hit-ratio">--%</h3>
                                <div class="small text-muted">Hit Ratio</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-center border rounded p-3">
                                <h3 id="avg-response-time">-- ms</h3>
                                <div class="small text-muted">Avg Response Time</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button class="btn btn-sm btn-outline-primary" id="clear-cache-btn">
                            <i class="fas fa-broom me-1"></i> Clear Cache
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/chart.min.js"></script>
<script>
    let trafficChart = null;
    let currentTrafficPeriod = 'day';
    
    $(document).ready(function() {
        // Initialize
        loadDashboardData();
        
        // Set up refresh button
        $('#refresh-status').click(function() {
            loadDashboardData();
        });
        
        // Reload configuration button
        $('.btn:contains("Reload Proxy Configuration")').click(function() {
            apiRequest('POST', 'maintenance/reload-config')
                .then(function(response) {
                    showToast('Configuration reloaded successfully');
                    loadDashboardData(); // Refresh dashboard data
                })
                .catch(function(error) {
                    showToast('Failed to reload configuration: ' + error.message, 'danger');
                });
        });
        
        // Import Logs button
        $('.btn:contains("Import Logs")').click(function() {
            apiRequest('POST', 'logs/import')
                .then(function(response) {
                    showToast('Logs imported successfully');
                    loadDashboardData(); // Refresh dashboard data
                })
                .catch(function(error) {
                    showToast('Failed to import logs: ' + error.message, 'danger');
                });
        });
        
        // Export Settings button
        $('.btn:contains("Export Settings")').click(function() {
            apiRequest('GET', 'maintenance/backup-config')
                .then(function(response) {
                    // Create a download link for the configuration
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(response.data));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "secure-proxy-config-" + new Date().toISOString().slice(0, 10) + ".json");
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                    
                    showToast('Configuration exported successfully');
                })
                .catch(function(error) {
                    showToast('Failed to export configuration: ' + error.message, 'danger');
                });
        });
        
        // Clear Logs button
        $('.btn:contains("Clear Logs")').click(function() {
            if (confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
                apiRequest('POST', 'logs/clear')
                    .then(function(response) {
                        showToast('Logs cleared successfully');
                        loadDashboardData(); // Refresh dashboard data
                    })
                    .catch(function(error) {
                        showToast('Failed to clear logs: ' + error.message, 'danger');
                    });
            }
        });
        
        // Optimize Cache button
        $('#optimize-cache-btn').click(function() {
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Optimizing...');
            
            apiRequest('POST', 'maintenance/optimize-cache')
                .then(function(response) {
                    showToast('Cache optimized successfully. ' + response.data.space_saved + ' of space saved.');
                    loadCacheStatistics();
                })
                .catch(function(error) {
                    showToast('Failed to optimize cache: ' + error.message, 'danger');
                })
                .finally(function() {
                    $('#optimize-cache-btn').prop('disabled', false).html('<i class="fas fa-tachometer-alt me-2"></i>Optimize Cache');
                });
        });
        
        // Security Scan button
        $('#scan-security-btn').click(function() {
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Scanning...');
            
            apiRequest('POST', 'security/scan') // Ensure this endpoint exists and is POST
            .then(function(response) {
                showToast(response.message || 'Security scan completed', 'success');
                // Reload security score and recommendations after scan
                if (typeof loadSecurityScore === 'function') {
                    loadSecurityScore(); 
                }
                // Optionally, display more details from response.security_issues
                if (response.issues_found > 0) {
                    let issuesHtml = '<ul>';
                    response.security_issues.forEach(issue => {
                        issuesHtml += `<li>${issue}</li>`;
                    });
                    issuesHtml += '</ul>';
                    // You might want to display these issues in a modal or a dedicated section
                    console.warn('Security issues found:', response.security_issues);
                    // Example: showToast(`Scan found ${response.issues_found} issues. Check console for details.`, 'warning');
                }
            })
            .catch(function(error) {
                showToast('Security scan failed: ' + error.message, 'danger');
            })
            .finally(function() {
                $(this).prop('disabled', false).html('<i class="fas fa-shield-alt me-2"></i>Security Scan');
            });
        });
        
        // Refresh security score button
        $('#refresh-security').click(function() {
            loadSecurityScore();
        });
        
        // Refresh cache statistics button
        $('#refresh-cache').click(function() {
            loadCacheStatistics();
        });
        
        // Clear cache button
        $('#clear-cache-btn').click(function() {
            if (confirm('Are you sure you want to clear the proxy cache?')) {
                apiRequest('POST', 'maintenance/clear-cache')
                    .then(function(response) {
                        showToast('Cache cleared successfully');
                        loadCacheStatistics();
                    })
                    .catch(function(error) {
                        showToast('Failed to clear cache: ' + error.message, 'danger');
                    });
            }
        });
        
        // Traffic period buttons
        $('.traffic-period').click(function() {
            $('.traffic-period').removeClass('active');
            $(this).addClass('active');
            currentTrafficPeriod = $(this).data('period');
            loadTrafficStatistics(currentTrafficPeriod);
        });
        
        // Client data toggle buttons
        $('.client-data-toggle').click(function() {
            $('.client-data-toggle').removeClass('active');
            $(this).addClass('active');
            const view = $(this).data('view');
            if (view === 'clients') {
                $('#client-list-view').show();
                $('#domain-list-view').hide();
            } else {
                $('#client-list-view').hide();
                $('#domain-list-view').show();
            }
        });
        
        // Set up automatic refresh every 30 seconds
        setInterval(function() {
            loadDashboardData(false);
        }, 30000);
    });
    
    function loadDashboardData(showLoading = true) {
        if (showLoading) {
            // Show loading indicator
            $('#proxy-status').text('Loading...');
            $('#proxy-status-card').text('Loading...');
        }
        
        // Load proxy status
        apiRequest('GET', 'status')
            .then(function(response) {
                if (response.status === 'success') {
                    const data = response.data;
                    
                    // Update proxy status card to show IP:PORT
                    const proxyInfoText = data.proxy_host && data.proxy_port ? `${data.proxy_host}:${data.proxy_port}` : 'N/A';
                    $('#proxy-status-card').text(proxyInfoText);

                    // Update detailed proxy status text (Running/Stopped)
                    const statusText = data.proxy_status === 'running' ? 'Running' : 'Stopped';
                    $('#proxy-status').text(statusText);
                    
                    // Update status indicators
                    $('#proxy-status-indicator, #proxy-status-indicator-card').removeClass('status-inactive status-active')
                        .addClass(data.proxy_status === 'running' ? 'status-active' : 'status-inactive');
                    
                    // Update other status information
                    const currentTime = new Date();
                    $('#status-time').text('Last updated: ' + currentTime.toLocaleTimeString());
                    $('#status-time-short').text(currentTime.toLocaleTimeString());
                    $('#proxy-version').text(data.version);
                    $('#memory-usage').text(data.memory_usage);
                    $('#cpu-usage').text(data.cpu_usage);
                    $('#uptime').text(data.uptime);
                    
                    // Set requests count for stats card and details card
                    if (data.hasOwnProperty('requests_count')) {
                        const requestCount = data.requests_count || 0;
                        $('#proxy-requests').text(requestCount);
                        $('#proxy-requests-card').text(requestCount);
                        
                        // Update subtitle based on count
                        if (requestCount === 0) {
                            $('#proxy-requests-subtitle').text('No traffic yet today');
                        } else if (requestCount === 1) {
                            $('#proxy-requests-subtitle').text('1 request today');
                        } else {
                            $('#proxy-requests-subtitle').text('Today\'s traffic');
                        }
                    } else {
                        $('#proxy-requests').text('N/A');
                        $('#proxy-requests-card').text('N/A');
                        $('#proxy-requests-subtitle').text('Data unavailable');
                    }
                }
            })
            .catch(function(error) {
                showToast('Failed to load proxy status: ' + error.message, 'danger');
            });
        
        // Load system information
        apiRequest('GET', 'settings')
            .then(function(response) {
                if (response.status === 'success') {
                    const settings = {};
                    response.data.forEach(setting => {
                        settings[setting.setting_name] = setting.setting_value;
                    });
                    
                    // Update settings information
                    $('#ip-block-status').text(settings.enable_ip_blacklist === 'true' ? 'Enabled' : 'Disabled');
                    $('#domain-block-status').text(settings.enable_domain_blacklist === 'true' ? 'Enabled' : 'Disabled');
                    $('#direct-ip-block-status').text(settings.block_direct_ip === 'true' ? 'Enabled' : 'Disabled');
                    $('#content-filtering-status').text(settings.enable_content_filtering === 'true' ? 'Enabled' : 'Disabled');
                }
            })
            .catch(function(error) {
                showToast('Failed to load settings: ' + error.message, 'danger');
            });
        
        // Load IP blacklist count
        apiRequest('GET', 'ip-blacklist')
            .then(function(response) {
                if (response.status === 'success') {
                    $('#blacklisted-ips').text(response.data.length);
                }
            })
            .catch(function(error) {
                $('#blacklisted-ips').text('Error');
            });
        
        // Load domain blacklist count
        apiRequest('GET', 'domain-blacklist')
            .then(function(response) {
                if (response.status === 'success') {
                    $('#blacklisted-domains').text(response.data.length);
                }
            })
            .catch(function(error) {
                $('#blacklisted-domains').text('Error');
            });
        
        // Load blocked requests count
        apiRequest('GET', 'logs/blocked-count')
            .then(function(response) {
                if (response.status === 'success') {
                    $('#blocked-requests').text(response.data.blocked_count);
                    $('#blocked-requests-card').text(response.data.blocked_count);
                }
            })
            .catch(function(error) {
                $('#blocked-requests').text('Error');
                $('#blocked-requests-card').text('Error');
            });
        
        // Load security score
        loadSecurityScore();
        
        // Load traffic statistics
        loadTrafficStatistics(currentTrafficPeriod);
        
        // Load cache statistics
        loadCacheStatistics();
        
        // Load client statistics
        loadClientStatistics();
        
        // Load domain statistics
        loadDomainStatistics();
    }
    
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }
    
    function loadSecurityScore() {
        apiRequest('GET', 'security/score')
            .then(function(response) {
                if (response.status === 'success') {
                    const data = response.data;
                    
                    // Update score
                    $('#security-score').text(data.score);
                    $('#security-score-card').text(data.score);
                    
                    // Update status
                    let statusClass = '';
                    if (data.security_status === 'secure') {
                        statusClass = 'text-success';
                    } else if (data.security_status === 'adequate') {
                        statusClass = 'text-warning';
                    } else {
                        statusClass = 'text-danger';
                    }
                    
                    $('#security-status').text(data.message).removeClass('text-success text-warning text-danger').addClass(statusClass);
                    $('#security-status-card').text(data.message).removeClass('text-success text-warning text-danger').addClass(statusClass);
                    
                    // Update recommendations
                    if (data.recommendations.length > 0) {
                        let html = '';
                        data.recommendations.forEach(recommendation => {
                            html += `<li>${recommendation}</li>`;
                        });
                        $('#recommendations-list').html(html);
                    } else {
                        $('#recommendations-list').html('<li>No recommendations at this time. Your security settings are optimal.</li>');
                    }
                    
                    // Update circle color
                    const circleColor = data.score >= 80 ? '#2ecc71' : (data.score >= 50 ? '#f39c12' : '#e74c3c');
                    
                    // Apply styles to create the circle with the score inside
                    $('.security-score-circle').css({
                        'background': `conic-gradient(${circleColor} ${data.score * 3.6}deg, #eee 0deg)`,
                        'border-radius': '50%'
                    });
                }
            })
            .catch(function(error) {
                showToast('Failed to load security score: ' + error.message, 'danger');
            });
    }
    
    function loadTrafficStatistics(period) {
        apiRequest('GET', `traffic/statistics?period=${period}`)
            .then(function(response) {
                if (response.status === 'success') {
                    const data = response.data;
                    
                    // Update totals
                    $('#total-allowed').text(data.total_allowed);
                    $('#total-blocked').text(data.total_blocked);
                    $('#active-connections').text(data.active_connections);
                    
                    // Update chart
                    if (trafficChart) {
                        trafficChart.destroy();
                    }
                    
                    const ctx = document.getElementById('traffic-chart').getContext('2d');
                    trafficChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.labels,
                            datasets: [
                                {
                                    label: 'Allowed',
                                    data: data.allowed_traffic,
                                    backgroundColor: 'rgba(46, 204, 113, 0.2)',
                                    borderColor: 'rgba(46, 204, 113, 1)',
                                    borderWidth: 2,
                                    tension: 0.4
                                },
                                {
                                    label: 'Blocked',
                                    data: data.blocked_traffic,
                                    backgroundColor: 'rgba(231, 76, 60, 0.2)',
                                    borderColor: 'rgba(231, 76, 60, 1)',
                                    borderWidth: 2,
                                    tension: 0.4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            }
                        }
                    });
                }
            })
            .catch(function(error) {
                showToast('Failed to load traffic statistics: ' + error.message, 'danger');
            });
    }
    
    function loadCacheStatistics() {
        apiRequest('GET', 'cache/statistics')
            .then(function(response) {
                if (response.status === 'success') {
                    const data = response.data;
                    
                    // Update cache usage bar
                    const usagePercentage = data.cache_usage_percentage || 0;
                    $('#cache-usage-bar').css('width', usagePercentage + '%');
                    
                    // Change color based on usage percentage
                    if (usagePercentage >= 90) {
                        $('#cache-usage-bar').removeClass('bg-info bg-warning bg-success').addClass('bg-danger');
                    } else if (usagePercentage >= 70) {
                        $('#cache-usage-bar').removeClass('bg-info bg-danger bg-success').addClass('bg-warning');
                    } else if (usagePercentage > 0) {
                        $('#cache-usage-bar').removeClass('bg-info bg-warning bg-danger').addClass('bg-success');
                    } else {
                        $('#cache-usage-bar').removeClass('bg-success bg-warning bg-danger').addClass('bg-info');
                    }
                    
                    // Update cache size text
                    $('#cache-used').text(data.cache_usage || 0);
                    $('#cache-total').text(data.cache_size || 0);
                    
                    // Update hit ratio
                    $('#hit-ratio').text(((data.hit_ratio || 0).toFixed(1)) + '%');
                    
                    // Update average response time
                    if (typeof data.avg_response_time === 'number') {
                        // Convert seconds to milliseconds for display
                        const responseTimeMs = (data.avg_response_time * 1000).toFixed(0);
                        $('#avg-response-time').text(responseTimeMs + ' ms');
                        
                        // Style based on performance
                        if (responseTimeMs < 100) {
                            $('#avg-response-time').removeClass('text-warning text-danger').addClass('text-success');
                        } else if (responseTimeMs < 500) {
                            $('#avg-response-time').removeClass('text-success text-danger').addClass('text-warning');
                        } else {
                            $('#avg-response-time').removeClass('text-success text-warning').addClass('text-danger');
                        }
                    } else {
                        $('#avg-response-time').text(data.avg_response_time || '-- ms');
                        $('#avg-response-time').removeClass('text-success text-warning text-danger');
                    }
                }
            })
            .catch(function(error) {
                showToast('Failed to load cache statistics: ' + error.message, 'danger');
            });
    }
    
    function loadClientStatistics() {
        apiRequest('GET', 'clients/statistics')
            .then(function(response) {
                const clientListTable = $('#client-list-table');
                clientListTable.empty(); // Clear previous entries
                
                // Update total count badge
                if (response.status === 'success' && response.data && response.data.total_clients) {
                    $('#total-clients-count').text(response.data.total_clients);
                }

                if (response.status === 'success' && response.data) {
                    // Access the clients array inside the data object
                    const clientsData = response.data.clients;
                    
                    if (!clientsData || !Array.isArray(clientsData) || clientsData.length === 0) {
                        clientListTable.html('<tr><td colspan="3" class="text-center">No client data available.</td></tr>');
                        return;
                    }
                    
                    let html = '';
                    clientsData.forEach(client => {
                        html += `<tr>
                                    <td>${client.ip_address || 'N/A'}</td>
                                    <td>${client.requests || 0}</td>
                                    <td><span class="badge bg-success">${client.status || 'Active'}</span></td>
                                 </tr>`;
                    });
                    clientListTable.html(html);
                    clientListTable.html(html);
                } else {
                    if (response.status !== 'success') {
                        clientListTable.html('<tr><td colspan="3" class="text-center text-danger">Failed to load client data.</td></tr>');
                        showToast('Failed to load client statistics: ' + (response.message || 'Unknown error'), 'danger');
                    } else if (!response.data) {
                        clientListTable.html('<tr><td colspan="3" class="text-center text-muted">No data received for client statistics.</td></tr>');
                    } else { // Data is present but not an array
                        clientListTable.html('<tr><td colspan="3" class="text-center text-danger">Invalid data format for client statistics.</td></tr>');
                        console.error("Client statistics data format:", response.data);
                        showToast('Client statistics data format error.', 'danger');
                    }
                }
            })
            .catch(function(error) {
                const clientListTable = $('#client-list-table');
                clientListTable.html('<tr><td colspan="3" class="text-center text-danger">Error loading client data.</td></tr>');
                showToast('Failed to load client statistics: ' + error.message, 'danger');
            });
    }

    function loadDomainStatistics() {
        apiRequest('GET', 'domains/statistics')
            .then(function(response) {
                const domainListTable = $('#domain-list-table');
                domainListTable.empty(); // Clear previous entries

                // Update total count badge
                if (response.status === 'success' && response.data && response.data.total_domains) {
                    $('#total-domains-count').text(response.data.total_domains);
                }

                if (response.status === 'success' && response.data) {
                    // Access the domains array inside the data object
                    const domainsData = response.data.domains;
                    
                    if (!domainsData || !Array.isArray(domainsData) || domainsData.length === 0) {
                        domainListTable.html('<tr><td colspan="3" class="text-center">No domain data available.</td></tr>');
                        return;
                    }
                    
                    let html = '';
                    domainsData.forEach(domain => {
                        // Determine badge color based on status
                        let badgeClass = 'bg-info';
                        if (domain.category === 'Allowed') {
                            badgeClass = 'bg-success';
                        } else if (domain.category === 'Blocked') {
                            badgeClass = 'bg-danger';
                        }
                        
                        html += `<tr>
                                    <td>${domain.domain_name || 'N/A'}</td>
                                    <td>${domain.requests || 0}</td>
                                    <td><span class="badge ${badgeClass}">${domain.category || 'Unknown'}</span></td>
                                 </tr>`;
                    });
                    domainListTable.html(html);
                    domainListTable.html(html);
                } else {
                    if (response.status !== 'success') {
                        domainListTable.html('<tr><td colspan="3" class="text-center text-danger">Failed to load domain data.</td></tr>');
                        showToast('Failed to load domain statistics: ' + (response.message || 'Unknown error'), 'danger');
                    } else if (!response.data) {
                        domainListTable.html('<tr><td colspan="3" class="text-center text-muted">No data received for domain statistics.</td></tr>');
                    } else { // Data is present but not expected format
                        domainListTable.html('<tr><td colspan="3" class="text-center text-danger">Invalid data format for domain statistics.</td></tr>');
                        console.error("Domain statistics data format:", response.data);
                        showToast('Domain statistics data format error.', 'danger');
                    }
                }
            })
            .catch(function(error) {
                const domainListTable = $('#domain-list-table');
                domainListTable.html('<tr><td colspan="3" class="text-center text-danger">Error loading domain data.</td></tr>');
                showToast('Failed to load domain statistics: ' + error.message, 'danger');
            });
    }
</script>
{% endblock %}