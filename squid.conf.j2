http_port {{ port }}
{% if ssl_intercept %}
https_port {{ ssl_port }} intercept
{% endif %}

acl allowed_ips src {{ allowed_ips | join(', ') }}
http_access allow allowed_ips
http_access deny all

{% for i, path in ip_blacklists | enumerate %}
acl blacklisted_ips_{{ i }} dstdomain "{{ path }}"
{% endfor %}
{% for i in range(ip_blacklists | length) %}
http_access deny blacklisted_ips_{{ i }}
{% endfor %}

{% for i, path in dns_blacklists | enumerate %}
acl blacklisted_domains_{{ i }} dstdomain "{{ path }}"
{% endfor %}
{% for i in range(dns_blacklists | length) %}
http_access deny blacklisted_domains_{{ i }}
{% endfor %}

{% if owasp_rules_file %}
acl owasp url_regex -i {{ owasp_rules_file }}
http_access deny owasp
{% endif %}

{% if block_vpn %}
{% for i, path in vpn_ips | enumerate %}
acl vpn_ips_{{ i }} src "{{ path }}"
{% endfor %}
{% for i in range(vpn_ips | length) %}
http_access deny vpn_ips_{{ i }}
{% endfor %}
{% endif %}

{% if block_tor %}
{% for i, path in tor_ips | enumerate %}
acl tor_ips_{{ i }} src "{{ path }}"
{% endfor %}
{% for i in range(tor_ips | length) %}
http_access deny tor_ips_{{ i }}
{% endfor %}
{% endif %}


{% if block_cloudflare %}
{% for i, path in cloudflare_ips | enumerate %}
acl cloudflare_ips_{{ i }} src "{{ path }}"
{% endfor %}
{% for i in range(cloudflare_ips | length) %}
http_access deny cloudflare_ips_{{ i }}
{% endfor %}
{% endif %}


{% if block_aws %}
{% for i, path in aws_ips | enumerate %}
acl aws_ips_{{ i }} src "{{ path }}"
{% endfor %}
{% for i in range(aws_ips | length) %}
http_access deny aws_ips_{{ i }}
{% endfor %}
{% endif %}


{% if block_microsoft %}
{% for i, path in microsoft_ips | enumerate %}
acl microsoft_ips_{{ i }} src "{{ path }}"
{% endfor %}
{% for i in range(microsoft_ips | length) %}
http_access deny microsoft_ips_{{ i }}
{% endfor %}
{% endif %}


{% if block_google %}
{% for i, path in google_ips | enumerate %}
acl google_ips_{{ i }} src "{{ path }}"
{% endfor %}
{% for i in range(google_ips | length) %}
http_access deny google_ips_{{ i }}
{% endfor %}
{% endif %}

{% if user_agent_rewrite.enabled %}
{% for i, rule in user_agent_rewrite.rules | enumerate %}
acl rewrite_ua_{{ i }} browser {{ rule.user_agent }}
{% if not rule.block %}
request_header_replace User-Agent "{{ rule.rewrite_to }}" rewrite_ua_{{ i }}
{% else %}
http_access deny rewrite_ua_{{ i }}
{% endif %}
{% endfor %}
{% endif %}

access_log {{ logging.access_log | default("/var/log/squid/access.log") }} {{ logging.log_format | default("combined") }}
cache_log {{ logging.cache_log | default("/var/log/squid/cache.log") }}

{% if cache.enabled %}
cache_dir {{ cache.cache_dir | default("aufs") }} {{ cache.cache_size | default(10000) }} 16 256
maximum_object_size {{ cache.max_object_size | default("512 MB") }}
{% endif %}


{% if authentication.enabled %}
auth_param basic program /usr/lib/squid/basic_ncsa_auth {{ authentication.auth_file | default("/etc/squid/passwords") }}
acl authenticated_users proxy_auth {{ authentication.auth_users | join(' ')}}
http_access allow authenticated_users
{% endif %}

{% for restriction in time_restrictions %}
acl {{ restriction.name }} time {{ restriction.days }} {{ restriction.time }}
http_access {{ restriction.action }} {{ restriction.name }}
{% endfor %}

{% for acl in custom_acls %}
acl {{ acl.name }} {{ acl.type }} {{ acl.values | join(', ') }}
http_access {{ acl.action }} {{ acl.name }}
{% endfor %}
