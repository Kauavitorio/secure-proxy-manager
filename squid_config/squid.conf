# Basic Squid configuration file
# Default port is 3128
http_port 3128

# Set the cache directories
cache_dir ufs /var/cache/squid 100 16 256

# Set log file
access_log /var/log/squid/access.log
cache_log /var/log/squid/cache.log
cache_store_log /var/log/squid/store.log

# --- NETWORK ACCESS CONTROL LISTS ---
# Allow all local networks
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16
acl localnet src fc00::/7
acl localnet src fe80::/10

# --- PORT RESTRICTIONS ---
# Only allow HTTP, HTTPS, and other safe ports
acl SSL_ports port 443
acl Safe_ports port 80         # http
acl Safe_ports port 443        # https
acl Safe_ports port 21         # ftp
acl Safe_ports port 70         # gopher
acl Safe_ports port 210        # wais
acl Safe_ports port 1025-65535 # unregistered ports
acl Safe_ports port 280        # http-mgmt
acl Safe_ports port 488        # gss-http
acl Safe_ports port 591        # filemaker
acl Safe_ports port 777        # multiling http

# --- IP BLACKLIST ---
# Sample blacklisted IPs (add your own)
acl blacklist_ips src "/etc/squid/blacklist_ips.txt"

# --- DOMAIN BLACKLIST ---
# Blocked domains list (add your own)
acl blacklist_domains dstdomain "/etc/squid/blacklist_domains.txt"

# --- DIRECT IP ACCESS CONTROL ---
# Prevent direct IP address access (except for allowed IPs)
acl direct_ip_access url_regex ^https?://[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+
acl allowed_direct_ips src "/etc/squid/allowed_direct_ips.txt"

# --- USER AGENT FILTERING ---
# Block suspicious user agents
acl bad_user_agents browser "/etc/squid/bad_user_agents.txt"

# --- CONTENT FILTERING ---
# Block common malware file extensions
acl malware_extensions urlpath_regex -i \.(exe|dll|bat|cmd|scr|js)$

# --- TIME RESTRICTIONS ---
# Define business hours (optional)
acl business_hours time MTWHF 8:00-17:00

# --- ACCESS RULES ---

# Deny blacklisted IPs
http_access deny blacklist_ips

# Deny blacklisted domains
http_access deny blacklist_domains

# Block suspicious user agents
http_access deny bad_user_agents

# Block direct IP access except for allowed IPs
http_access deny direct_ip_access !allowed_direct_ips

# Block common malware extensions
http_access deny malware_extensions

# Deny requests to unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than SSL ports
http_access deny CONNECT !SSL_ports

# Allow localhost and localnet
http_access allow localhost manager
http_access allow localnet
http_access allow localhost

# Deny all other access
http_access deny all

# --- CACHING PARAMETERS ---
# Set the maximum object size
maximum_object_size 10 MB

# Do not cache common dynamic content
acl no_cache url_regex -i \.(php|cgi|pl|py)$
cache deny no_cache

# HTTPS caching directives
ssl_bump server-first all
sslproxy_cert_error deny all
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/ssl_db -M 4MB
sslcrtd_children 5

# --- DNS SETTINGS ---
# DNS server options
dns_nameservers 8.8.8.8 1.1.1.1
dns_timeout 5 seconds

# --- ADDITIONAL SECURITY SETTINGS ---
# Prevent cache poisoning
request_header_access X-Forwarded-For deny all
request_header_access Via deny all
request_header_access Cache-Control deny all

# Set the hostname
visible_hostname squid-proxy

# Specify coredump directory
coredump_dir /var/cache/squid

# --- REFRESH PATTERNS ---
# Refresh patterns for different types of content
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern \.(gif|png|jpg|jpeg|ico)$ 10080  50%     40320  override-expire override-lastmod reload-into-ims
refresh_pattern \.(iso|avi|wav|mp3|mp4|mpeg|swf|flv|x-flv)$ 43200 50% 432000  override-expire override-lastmod reload-into-ims
refresh_pattern \.(deb|rpm|exe|zip|tar|tgz|gz|bz2)$ 10080 90% 43200 override-expire override-lastmod reload-into-ims
refresh_pattern .               0       20%     4320